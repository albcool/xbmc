From 3dcc860bafeab8b3ec9109b74a93fcbe33f599b0 Mon Sep 17 00:00:00 2001
From: Anton Fedchin <afedchin@ruswizards.com>
Date: Thu, 9 Jan 2014 18:13:49 +0400
Subject: [PATCH] Change-fallthrough-logic-for-read_seek-to-be-based-o

---
 libavformat/asfdec.c |    2 +-
 libavformat/gxf.c    |    4 ++--
 libavformat/jvdec.c  |    2 +-
 libavformat/oggdec.c |    4 +++-
 libavformat/pmpdec.c |    2 +-
 libavformat/r3d.c    |    2 +-
 libavformat/utils.c  |    4 +++-
 7 files changed, 12 insertions(+), 8 deletions(-)

diff --git a/libavformat/asfdec.c b/libavformat/asfdec.c
index 528bcbd..9f5f3af 100644
--- a/libavformat/asfdec.c
+++ b/libavformat/asfdec.c
@@ -1516,7 +1516,7 @@ static int asf_read_seek(AVFormatContext *s, int stream_index,
     AVStream *st    = s->streams[stream_index];
 
     if (s->packet_size <= 0)
-        return -1;
+        return AVERROR(ENOSYS);
 
     /* Try using the protocol's read_seek if available */
     if (s->pb) {
diff --git a/libavformat/gxf.c b/libavformat/gxf.c
index e15d06a..b1d6228 100644
--- a/libavformat/gxf.c
+++ b/libavformat/gxf.c
@@ -567,7 +567,7 @@ static int gxf_seek(AVFormatContext *s, int stream_index, int64_t timestamp, int
     idx = av_index_search_timestamp(st, timestamp - start_time,
                                     AVSEEK_FLAG_ANY | AVSEEK_FLAG_BACKWARD);
     if (idx < 0)
-        return -1;
+        return AVERROR(ENOSYS);
     pos = st->index_entries[idx].pos;
     if (idx < st->nb_index_entries - 2)
         maxlen = st->index_entries[idx + 2].pos - pos;
@@ -577,7 +577,7 @@ static int gxf_seek(AVFormatContext *s, int stream_index, int64_t timestamp, int
         return res;
     found = gxf_resync_media(s, maxlen, -1, timestamp);
     if (FFABS(found - timestamp) > 4)
-        return -1;
+        return AVERROR(ENOSYS);
     return 0;
 }
 
diff --git a/libavformat/jvdec.c b/libavformat/jvdec.c
index 69ac8f2..d801086 100644
--- a/libavformat/jvdec.c
+++ b/libavformat/jvdec.c
@@ -209,7 +209,7 @@ static int read_seek(AVFormatContext *s, int stream_index,
     }
 
     if (i < 0 || i >= ast->nb_index_entries)
-        return 0;
+        return -1;
     if (avio_seek(s->pb, ast->index_entries[i].pos, SEEK_SET) < 0)
         return -1;
 
diff --git a/libavformat/oggdec.c b/libavformat/oggdec.c
index a099eb3..e48e976 100644
--- a/libavformat/oggdec.c
+++ b/libavformat/oggdec.c
@@ -845,8 +845,10 @@ static int ogg_read_seek(AVFormatContext *s, int stream_index,
 
     ret = ff_seek_frame_binary(s, stream_index, timestamp, flags);
     os  = ogg->streams + stream_index;
-    if (ret < 0)
+    if (ret < 0) {
         os->keyframe_seek = 0;
+        ret = AVERROR(ENOSYS);
+    }
     return ret;
 }
 
diff --git a/libavformat/pmpdec.c b/libavformat/pmpdec.c
index 71f450e..79330f4 100644
--- a/libavformat/pmpdec.c
+++ b/libavformat/pmpdec.c
@@ -182,7 +182,7 @@ static int pmp_close(AVFormatContext *s)
 {
     PMPContext *pmp = s->priv_data;
     av_freep(&pmp->packet_sizes);
-    return 0;
+    return AVERROR(ENOSYS);
 }
 
 AVInputFormat ff_pmp_demuxer = {
diff --git a/libavformat/r3d.c b/libavformat/r3d.c
index 0719fb6..e13b7b3 100644
--- a/libavformat/r3d.c
+++ b/libavformat/r3d.c
@@ -369,7 +369,7 @@ static int r3d_seek(AVFormatContext *s, int stream_index, int64_t sample_time, i
     int frame_num;
 
     if (!st->avg_frame_rate.num)
-        return -1;
+        return AVERROR(ENOSYS);
 
     frame_num = av_rescale_q(sample_time, st->time_base,
                              av_inv_q(st->avg_frame_rate));
diff --git a/libavformat/utils.c b/libavformat/utils.c
index bcea353..7cfa64f 100644
--- a/libavformat/utils.c
+++ b/libavformat/utils.c
@@ -2042,10 +2042,12 @@ static int seek_frame_internal(AVFormatContext *s, int stream_index,
         ff_read_frame_flush(s);
         ret = s->iformat->read_seek(s, stream_index, timestamp, flags);
     } else
-        ret = -1;
+        ret = AVERROR(ENOSYS);
     if (ret >= 0) {
         return 0;
     }
+    if (ret != AVERROR(ENOSYS))
+        return ret;
 
     if (s->iformat->read_timestamp && !(s->iformat->flags & AVFMT_NOBINSEARCH)) {
         ff_read_frame_flush(s);
-- 
1.7.10.msysgit.1

