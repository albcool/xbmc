From a487bf8086db32b9fb8d835fcd9b9d1f22e931f6 Mon Sep 17 00:00:00 2001
From: Anton Fedchin <afedchin@ruswizards.com>
Date: Thu, 9 Jan 2014 18:36:40 +0400
Subject: [PATCH] dxva-mpeg2 speed up slice allocation

---
 libavcodec/dxva2.h       |    1 +
 libavcodec/dxva2_mpeg2.c |   13 +++++++++++++
 2 files changed, 14 insertions(+)

diff --git a/libavcodec/dxva2.h b/libavcodec/dxva2.h
index ac39e06..881b48d 100644
--- a/libavcodec/dxva2.h
+++ b/libavcodec/dxva2.h
@@ -86,6 +86,7 @@ struct dxva_context {
      * Private to the FFmpeg AVHWAccel implementation
      */
     unsigned report_id;
+    unsigned last_slice_count;
 };
 
 /**
diff --git a/libavcodec/dxva2_mpeg2.c b/libavcodec/dxva2_mpeg2.c
index 06b3623..1c35d61 100644
--- a/libavcodec/dxva2_mpeg2.c
+++ b/libavcodec/dxva2_mpeg2.c
@@ -224,6 +224,16 @@ static int dxva2_mpeg2_start_frame(AVCodecContext *avctx,
     ctx_pic->slice_alloc    = 0;
     ctx_pic->bitstream_size = 0;
     ctx_pic->bitstream      = NULL;
+
+    if (ctx->last_slice_count > 0)
+    {
+        ctx_pic->slice = av_fast_realloc(NULL,
+                                         &ctx_pic->slice_alloc,
+                                         ctx->last_slice_count * sizeof(DXVA_SliceInfo));
+        if (!ctx_pic->slice)
+            return -1;
+    }
+
     return 0;
 }
 
@@ -258,6 +268,7 @@ static int dxva2_mpeg2_end_frame(AVCodecContext *avctx)
     struct MpegEncContext *s = avctx->priv_data;
     struct dxva2_picture_context *ctx_pic =
         s->current_picture_ptr->hwaccel_picture_private;
+    struct dxva_context *ctx = avctx->hwaccel_context;
     int ret;
 
     if (ctx_pic->slice_count <= 0 || ctx_pic->bitstream_size <= 0)
@@ -269,6 +280,8 @@ static int dxva2_mpeg2_end_frame(AVCodecContext *avctx)
     av_freep(ctx_pic->slice);
     if (!ret)
         ff_mpeg_draw_horiz_band(s, 0, avctx->height);
+
+    ctx->last_slice_count = ctx_pic->slice_count;
     return ret;
 }
 
-- 
1.7.10.msysgit.1

